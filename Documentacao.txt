
# üìö Biblioteca API ‚Äì Guia Completo de Estudo

Este documento serve como **fonte √∫nica de estudo** do projeto Biblioteca API. A ideia √© que, ao voltar aqui no futuro, voc√™ consiga entender **o porqu√™ de cada decis√£o**, **como as pe√ßas se conectam** e **como evoluir o sistema com seguran√ßa**.

---

## 1Ô∏è‚É£ Vis√£o Geral do Projeto

A Biblioteca API √© uma **API REST** constru√≠da com:

* **FastAPI** ‚Üí camada HTTP
* **SQLAlchemy** ‚Üí ORM (mapeamento objeto-relacional)
* **Pydantic** ‚Üí valida√ß√£o e serializa√ß√£o de dados
* **PostgreSQL** ‚Üí banco de dados relacional
* **Alembic** ‚Üí versionamento de schema (migrations)

O sistema modela um dom√≠nio cl√°ssico de biblioteca:

* Usu√°rios
* Livros
* Empr√©stimos
* Reservas
* Multas

Tudo foi pensado para **separar responsabilidades**, evitar acoplamento e permitir evolu√ß√£o segura.

---

## 2Ô∏è‚É£ Estrutura de Pastas (Mental Map)

```
app/
 ‚îú‚îÄ‚îÄ main.py           # ponto de entrada FastAPI
 ‚îú‚îÄ‚îÄ database.py       # engine, SessionLocal, Base
 ‚îú‚îÄ‚îÄ deps.py           # depend√™ncias (ex: get_db)
 ‚îú‚îÄ‚îÄ models/           # modelos SQLAlchemy
 ‚îú‚îÄ‚îÄ schemas/          # schemas Pydantic
 ‚îú‚îÄ‚îÄ crud/             # regras de acesso ao banco
 ‚îú‚îÄ‚îÄ routers/          # endpoints HTTP
 ‚îî‚îÄ‚îÄ alembic/          # migrations
```

Essa separa√ß√£o evita o famoso **"arquivo deus"** e facilita testes e manuten√ß√£o.

---

## 3Ô∏è‚É£ Banco de Dados (database.py)

### engine

```python
engine = create_engine(DATABASE_URL, echo=True, future=True)
```

* Cria a conex√£o com o banco
* `future=True` ‚Üí compat√≠vel com SQLAlchemy 2.x
* `echo=True` ‚Üí loga SQL (bom para aprendizado)

### SessionLocal

```python
SessionLocal = sessionmaker(bind=engine, autoflush=False, expire_on_commit=False)
```

* Cada request recebe **uma sess√£o pr√≥pria**
* Nada de conex√µes globais

### Base

```python
Base = declarative_base()
```

* Base comum para todos os models
* Alembic usa `Base.metadata`

üö´ **Nunca usar `create_all` em produ√ß√£o**
‚úîÔ∏è Sempre usar **Alembic**

---

## 4Ô∏è‚É£ Dependency Injection (deps.py)

```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

* FastAPI injeta automaticamente a sess√£o
* Garante `commit/rollback` controlados
* Evita vazamento de conex√£o

---

## 5Ô∏è‚É£ Models (SQLAlchemy)

### Conceitos-chave

* Cada classe ‚Üí uma tabela
* Cada atributo ‚Üí uma coluna
* `relationship` ‚Üí liga√ß√£o entre tabelas
* `Enum` ‚Üí regras de dom√≠nio no banco

### Exemplo mental

* `Usuario` ‚Üí pode ter muitos `Emprestimos`
* `Emprestimo` ‚Üí pertence a um `Usuario` e um `Livro`
* `Multa` ‚Üí depende de um `Emprestimo`

Cascade √© usado para:

* deletar dados filhos automaticamente
* evitar registros √≥rf√£os

---

## 6Ô∏è‚É£ Schemas (Pydantic)

Os schemas **n√£o s√£o models**.

Eles servem para:

* validar entrada (Create / Update)
* controlar sa√≠da (Out)
* proteger o banco de dados

### Padr√£o usado

* `XCreate` ‚Üí dados de entrada
* `XUpdate` ‚Üí campos opcionais
* `XOut` ‚Üí resposta da API

```python
class Config:
    orm_mode = True
```

Permite que Pydantic leia objetos SQLAlchemy diretamente.

---

## 7Ô∏è‚É£ CRUD (Camada de Persist√™ncia)

O CRUD √© o **√∫nico lugar** que fala com o banco.

### Responsabilidades

* montar queries
* aplicar regras simples
* n√£o saber nada de HTTP

### Exemplo

```python
db.query(Model).filter(...).first()
```

Se amanh√£ trocar FastAPI por outra coisa, o CRUD continua v√°lido.

---

## 8Ô∏è‚É£ Regras de Neg√≥cio Importantes

### Empr√©stimo

* come√ßa como `ativo`
* possui data prevista
* pode ser renovado

### Devolu√ß√£o

* s√≥ empr√©stimo ativo pode ser devolvido
* gera multa se houver atraso

### Multa

* valor calculado por dias de atraso
* status: pendente / paga / cancelada

Essas regras ficam **no CRUD**, n√£o no router.

---

## 9Ô∏è‚É£ Routers (FastAPI)

Routers cuidam apenas de:

* receber request
* validar payload
* chamar CRUD
* devolver response

Nada de regra de neg√≥cio pesada aqui.

FastAPI + Pydantic cuidam da convers√£o autom√°tica ORM ‚Üí JSON.

---

## üîü Alembic (Migrations)

### Princ√≠pio

> O banco nunca √© criado manualmente.

Tudo passa por migration.

### Fluxo padr√£o

```bash
alembic revision --autogenerate -m "descricao"
alembic upgrade head
```

### Estado atual

```
91a88286b7f7 (head)
```

Isso significa:

* banco sincronizado
* schema versionado
* ambiente saud√°vel

---

## 1Ô∏è‚É£1Ô∏è‚É£ Boas Pr√°ticas Consolidadas

* Nunca usar `create_all`
* Nunca acessar banco direto no router
* Sempre versionar migrations no Git
* Separar leitura e escrita
* Preferir filtros no banco, n√£o em listas Python

---

## 1Ô∏è‚É£2Ô∏è‚É£ Como Estudar Esse Projeto no Futuro

Sugest√£o de ordem:

1. Ler este documento
2. Olhar `models/`
3. Entender `schemas/`
4. Estudar `crud/`
5. Ver `routers/`
6. Revisar migrations

Se voc√™ entender **por que cada camada existe**, voc√™ domina o projeto.

---

## üß† Conclus√£o

Este projeto n√£o √© apenas uma API.

Ele √© um **laborat√≥rio de arquitetura backend**, usando pr√°ticas reais de mercado:

* separa√ß√£o de camadas
* versionamento de banco
* regras de neg√≥cio expl√≠citas
* c√≥digo sustent√°vel

Guardar este guia √© guardar o **mapa mental do sistema**.
